#!/usr/bin/env python3

import sys
import argparse
import hashlib
from pathlib import Path

try:
    from scriptlog import Logger
except ImportError:
    sys.path.insert(0, str(Path(__file__).parent))
    from scriptlog import Logger

logger = Logger(use_timestamps=False)


def hash_data(algorithm: str, data: bytes) -> str:
    try:
        hasher = hashlib.new(algorithm)
        hasher.update(data)
        return hasher.hexdigest()
    except ValueError:
        logger.error(f"Unsupported algorithm '{algorithm}'")
        sys.exit(1)


def main() -> int:
    algorithms = ', '.join(sorted(hashlib.algorithms_available))
    parser = argparse.ArgumentParser(
        description=f"Hash text or file content. Default algorithm: sha256. Supported: {algorithms}",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
examples:
  Hash text with default sha256:
    %(prog)s mypassword

  Hash text with specific algorithm:
    %(prog)s -a md5 mypassword

  Hash file with default sha256:
    %(prog)s -f myfile.txt

  Hash file with specific algorithm:
    %(prog)s -a sha512 -f myfile.txt
"""
    )

    parser.add_argument(
        'input',
        type=str,
        help="Input text or file path to hash"
    )

    parser.add_argument(
        '-a', '--algorithm',
        type=str,
        default='sha256',
        help="Hash algorithm to use (default: sha256)"
    )

    parser.add_argument(
        '-f', '--file',
        action='store_true',
        help="Treat input as file path"
    )

    args = parser.parse_args()

    if args.file:
        file_path = Path(args.input)
        if not file_path.is_file():
            logger.error(f"File not found: {args.input}")
            return 1

        try:
            data = file_path.read_bytes()
            input_type = 'file'
            input_display = str(file_path)
        except IOError as e:
            logger.error(f"Failed to read file: {e}")
            return 1
    else:
        data = args.input.encode('utf-8')
        input_type = 'text'
        input_display = args.input

    hash_result = hash_data(args.algorithm, data)

    print(f"Algorithm: {args.algorithm}")
    print(f"Input: '{input_display}' [{input_type}]")
    print(f"Hash: {hash_result}")

    return 0


if __name__ == "__main__":
    sys.exit(main())
