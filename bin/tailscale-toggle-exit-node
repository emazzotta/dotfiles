#!/bin/bash

set -euo pipefail

EXIT_NODE_NAME="ubuntu-devserver"

GREEN='\033[32m'
RED='\033[31m'
YELLOW='\033[33m'
RESET='\033[0m'

run_showip_if_available() {
    if command -v showip > /dev/null 2>&1; then
        printf "${YELLOW}●${RESET} IP → %s\n" "$(showip -e)"
    fi
}

check_tailscale_connected() {
    local state
    state=$(tailscale status --json | jq -r '.BackendState')
    if [ "$state" != "Running" ]; then
        printf "${YELLOW}●${RESET} Tailscale not connected (state: %s)\n" "$state"
        run_showip_if_available
        exit 0
    fi
}

active_exit_node() {
    tailscale status --json | jq -r '.Peer[] | select(.ExitNode == true) | .HostName'
}

check_tailscale_connected

current_node=$(active_exit_node)

if [ -n "$current_node" ]; then
    tailscale set --exit-node=
    printf "${RED}●${RESET} Exit node disabled\n"
else
    tailscale set --exit-node="$EXIT_NODE_NAME"
    printf "${GREEN}●${RESET} Exit node enabled → %s\n" "$EXIT_NODE_NAME"
fi

run_showip_if_available
