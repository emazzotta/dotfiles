#!/bin/bash

set -euo pipefail

EXIT_NODE_NAME="ubuntu-devserver"

GREEN='\033[32m'
RED='\033[31m'
YELLOW='\033[33m'
WHITE='\033[37m'
RESET='\033[0m'

WORK_IP="46.245.188.32"

run_showip_if_available() {
    if command -v showip > /dev/null 2>&1; then
        local ip color
        ip=$(showip -e)
        if [ "$ip" = "$WORK_IP" ]; then
            color="$GREEN"
        else
            color="$WHITE"
        fi
        printf "${color}●${RESET} IP → %s\n" "$ip"
    fi
}

check_tailscale_connected() {
    local state
    state=$(tailscale status --json | jq -r '.BackendState')
    if [ "$state" = "Running" ]; then
        printf "${GREEN}●${RESET} Tailscale is connected\n"
    else
        printf "${RED}●${RESET} Tailscale not connected\n"
        run_showip_if_available
        exit 0
    fi
}

active_exit_node() {
    tailscale status --json | jq -r '.Peer[] | select(.ExitNode == true) | .HostName'
}

check_tailscale_connected

current_node=$(active_exit_node)

if [ -n "$current_node" ]; then
    tailscale set --exit-node=
else
    tailscale set --exit-node="$EXIT_NODE_NAME"
fi

run_showip_if_available
