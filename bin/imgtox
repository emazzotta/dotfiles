#!/usr/bin/env python3

import argparse
import subprocess
import sys
from pathlib import Path

from scriptlog import Logger

logger = Logger()


def convert_image(input_file: Path, output_format: str, output_path: Path | None, delete_original: bool) -> Path | None:
    filename = input_file.stem
    if output_path:
        output_file = output_path / f"{filename}.{output_format}"
    else:
        output_file = Path.cwd() / f"{filename}.{output_format}"

    if output_file.exists():
        logger.warn(f"Output file '{output_file}' already exists, skipping...")
        return None

    command = ["magick", str(input_file), str(output_file)]
    result = subprocess.run(command, check=True)

    if result.returncode != 0:
        logger.error(f"Conversion failed for '{input_file}'")
        sys.exit(1)

    if delete_original:
        input_file.unlink()
        logger.log(f"Original file '{input_file}' deleted.")

    return output_file


def find_image_files(directory: Path) -> list[Path]:
    image_extensions = ['*.jpg', '*.jpeg', '*.png', '*.gif', '*.bmp', '*.tiff', '*.webp', '*.svg', '*.heic']
    image_extensions = image_extensions + [x.upper() for x in image_extensions]
    logger.log(str(image_extensions))
    image_files = []
    for extension in image_extensions:
        image_files.extend(directory.glob(f'**/{extension}'))
    return image_files


def main() -> None:
    parser = argparse.ArgumentParser(description='Convert image files.')
    parser.add_argument('-i', '--input', required=True, help='The image file or directory of image files to convert.')
    parser.add_argument('-f', '--format', required=True, dest='output_format',
                        help='The format of the output image file.')
    parser.add_argument('-d', '--delete', action='store_true', help='Delete the original file(s) after conversion.')
    parser.add_argument('-o', '--output-path', help='Path where to save the converted file(s).')
    args = parser.parse_args()

    input_path = Path(args.input)
    output_path = Path(args.output_path) if args.output_path else None

    if input_path.is_file():
        input_files = [input_path]
    elif input_path.is_dir():
        input_files = find_image_files(input_path)
    else:
        logger.error(f"Input '{args.input}' not found!")
        sys.exit(1)

    converted_files = []
    for input_file in input_files:
        result = convert_image(input_file, args.output_format, output_path, args.delete)
        if result:
            converted_files.append(result)

    for converted_file in converted_files:
        logger.success(f"Conversion complete: '{converted_file}'")


if __name__ == "__main__":
    main()
