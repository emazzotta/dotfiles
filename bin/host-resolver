#!/usr/bin/env python3

import platform
import queue
import socket
import subprocess
import sys
import threading
import time
from collections.abc import Iterator
from typing import Final

RESOLVE_TIMEOUT_MS: Final = 150

HOSTS: Final[dict[str, tuple[str, ...]]] = {
    "ci-macmini": ("ci-macmini.machines.leonardo.local", "Mac-mini-von-Andreas.local", "192.168.5.28"),
}

_PING_TIMEOUT_FLAG: Final = ["-W", str(RESOLVE_TIMEOUT_MS)] if platform.system() == "Darwin" else ["-W", str(RESOLVE_TIMEOUT_MS // 1000)]


def try_host(hostname: str) -> str | None:
    try:
        ip = socket.gethostbyname(hostname)
        result = subprocess.run(["ping", "-c", "1"] + _PING_TIMEOUT_FLAG + [ip], capture_output=True)
        if result.returncode == 0:
            print(f"Resolved {hostname} -> {ip}", file=sys.stderr)
            return ip
        return None
    except OSError:
        return None


def enforce_timeout(q: queue.Queue[str | None], count: int, timeout_ms: float) -> Iterator[str | None]:
    deadline = time.monotonic() + timeout_ms / 1000
    for _ in range(count):
        remaining = deadline - time.monotonic()
        if remaining <= 0:
            return
        try:
            yield q.get(timeout=remaining)
        except queue.Empty:
            return


def fetch_first_reachable(hostnames: tuple[str, ...]) -> str | None:
    results: queue.Queue[str | None] = queue.Queue()
    for hostname in hostnames:
        threading.Thread(target=lambda h=hostname: results.put(try_host(h)), daemon=True).start()
    return next((ip for ip in enforce_timeout(results, len(hostnames), RESOLVE_TIMEOUT_MS) if ip), None)


def resolve(short_name: str) -> str:
    if short_name not in HOSTS:
        print(f"Unknown host: {short_name}", file=sys.stderr)
        sys.exit(1)

    if ip := fetch_first_reachable(HOSTS[short_name]):
        return ip

    print(f"No reachable host found for {short_name}, falling back to 127.0.0.1", file=sys.stderr)
    return "127.0.0.1"


def main() -> None:
    if len(sys.argv) != 2:
        print(f"Usage: {sys.argv[0]} <host-short-name>", file=sys.stderr)
        sys.exit(1)

    print(resolve(sys.argv[1]))


if __name__ == "__main__":
    main()
