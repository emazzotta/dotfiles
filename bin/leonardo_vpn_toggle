#!/bin/bash

source leonardo_account

VPN_NAME="LeonardoVPN"
SERVER_ADDRESS="vpn.leonardo.ag"

is_leonardo_vpn_configured() {
    scutil --nc list | grep -q "$VPN_NAME"
    return $?
}

is_leonardo_vpn_connected() {
    if ! is_leonardo_vpn_configured; then
        create_vpn_config
    fi
    is_leonardo_vpn_configured && scutil --nc status "$VPN_NAME" | grep -qw "Connected"
    return $?
}

create_vpn_config() {
    if ! command -v macosvpn >/dev/null 2>&1; then
        printf "${RED}●${RESET} macosvpn is not installed. install via 'brew install macosvpn'\n"
        exit 1
    fi
    printf "${YELLOW}●${RESET} Creating VPN configuration with macosvpn...\n"
    if sudo macosvpn create --l2tp "$VPN_NAME" --endpoint "$SERVER_ADDRESS" --username "$AD_ACCOUNT" --password "$AD_PASSWORD" --sharedsecret "$VPN_SHARED_SECRET"; then
        printf "${GREEN}●${RESET} $VPN_NAME VPN configuration created successfully.\n"
    else
        printf "${RED}●${RESET} Failed to create VPN configuration.\n"
        return 1
    fi
}

connect_or_disconnect_vpn() {
    if [ "$1" != "--enable" ]; then
      if is_leonardo_vpn_connected; then
          read -r -p "$VPN_NAME is connected. Disconnect? (y/N): " user_input
          case $user_input in
              [Yy])
                  printf "${YELLOW}●${RESET} Disconnecting $VPN_NAME...\n"
                  umount "$NETWORK_DRIVE_MOUNT_POINT" &> /dev/null
                  scutil --nc stop "$VPN_NAME"
                  ;;
              *)
                  printf "${YELLOW}●${RESET} No changes made. VPN remains connected.\n"
                  ;;
          esac
      else
          printf "${YELLOW}●${RESET} $VPN_NAME is inactive\n"
      fi
    elif [ "$1" != "--disable" ]; then
        printf "${YELLOW}●${RESET} Connecting to $VPN_NAME...\n"
        scutil --nc start --secret "$VPN_SHARED_SECRET" "$VPN_NAME"
    fi
}

connect_or_disconnect_vpn "$1"
