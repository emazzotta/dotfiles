#!/bin/bash

source leonardo_account

VPN_NAME="LeonardoVPN"
SERVER_ADDRESS="vpn.leonardo.ag"

is_leonardo_vpn_configured() {
    scutil --nc list | grep -q "$VPN_NAME"
}

is_leonardo_vpn_connected() {
    if ! is_leonardo_vpn_configured; then
        create_vpn_config
    fi
    is_leonardo_vpn_configured && scutil --nc status "$VPN_NAME" | grep -qw "Connected"
}

create_vpn_config() {
    if ! command -v macosvpn >/dev/null 2>&1; then
        printf "${RED}●${RESET} macosvpn is not installed. install via 'brew install macosvpn'\n"
        exit 1
    fi
    printf "${YELLOW}●${RESET} Creating VPN configuration with macosvpn...\n"
    if sudo macosvpn create --l2tp "$VPN_NAME" --endpoint "$SERVER_ADDRESS" --username "$AD_ACCOUNT" --password "$AD_PASSWORD" --sharedsecret "$VPN_SHARED_SECRET"; then
        printf "${GREEN}●${RESET} $VPN_NAME VPN configuration created successfully.\n"
    else
        printf "${RED}●${RESET} Failed to create VPN configuration.\n"
        return 1
    fi
}

connect_vpn() {
    if is_leonardo_vpn_connected; then
        printf "${YELLOW}●${RESET} $VPN_NAME is already connected\n"
    else
        printf "${YELLOW}●${RESET} Connecting to $VPN_NAME...\n"
        scutil --nc start --secret "$VPN_SHARED_SECRET" "$VPN_NAME"
    fi
}

disconnect_vpn() {
    if ! is_leonardo_vpn_connected; then
        return 1
    fi
    umount "$NETWORK_DRIVE_MOUNT_POINT" &>/dev/null || true
    scutil --nc stop "$VPN_NAME"
    printf "${RED}●${RESET} $VPN_NAME disconnected\n"
}

toggle_vpn() {
    if is_leonardo_vpn_connected; then
        read -r -p "$VPN_NAME is connected. Disconnect? (y/N): " user_input
        case $user_input in
            [Yy])
                disconnect_vpn
                return 1
                ;;
            *)
                printf "${YELLOW}●${RESET} No changes made. VPN remains connected.\n"
                ;;
        esac
    else
        printf "${YELLOW}●${RESET} $VPN_NAME is inactive\n"
    fi
}

case "${1:-}" in
    --enable)  connect_vpn ;;
    --disable) disconnect_vpn ;;
    *)         toggle_vpn ;;
esac
