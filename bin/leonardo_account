#!/bin/bash

if [ "${BASH_SOURCE[0]}" = "${0}" ]; then
    set -euo pipefail
fi

export AD_ACCOUNT_KEYCHAIN_NAME="LeonardoActiveDirectoryUsername"

get_keychain_value() {
    local keychain_service=$1
    local hint=$2
    local value

    value=$(security find-generic-password -a "$keychain_service" -s "$keychain_service" -w 2>/dev/null || true)

    if [ -z "$value" ]; then
        add_value_to_keychain "$keychain_service" "$hint"
        value=$(security find-generic-password -a "$keychain_service" -s "$keychain_service" -w 2>/dev/null || true)

        if [ -z "$value" ]; then
            echo "Error: Failed to retrieve $keychain_service from keychain" >&2
            exit 1
        fi
    fi

    echo "$value"
}

add_value_to_keychain() {
    local keychain_service=$1
    local hint=$2
    local value

    if ! security find-generic-password -a "$keychain_service" -s "$keychain_service" &>/dev/null; then
        read -r -p "Enter $keychain_service${hint:+ ($hint)}: " value

        if [ -z "$value" ]; then
            echo "Error: No value provided for $keychain_service" >&2
            exit 1
        fi

        if ! security add-generic-password -a "$keychain_service" -s "$keychain_service" -w "$value"; then
            echo "Error: Failed to add $keychain_service to keychain" >&2
            exit 1
        fi
    fi
}

export AD_ACCOUNT
AD_ACCOUNT="$(get_keychain_value "$AD_ACCOUNT_KEYCHAIN_NAME" "firstname.lastname")"
export AD_PASSWORD_NAME="LeonardoActiveDirectory:$AD_ACCOUNT"

export VPN_SHARED_SECRET_NAME="LeonardoVPNSecret"

export NETWORK_DRIVE_FOLDER="Daten"
export NETWORK_DRIVE_SERVER_IP=192.168.5.155
export NETWORK_DRIVE_FULL_URL="smb://$AD_ACCOUNT@$NETWORK_DRIVE_SERVER_IP/$NETWORK_DRIVE_FOLDER"
export NETWORK_DRIVE_MOUNT_POINT="$HOME/$NETWORK_DRIVE_FOLDER"

export VM_DRIVE_MOUNT_POINT="smb://admin@192.168.5.7:4445/Devserver-Windows-VM"

get_keychain_password() {
    local keychain_account=$1
    local keychain_password_name=$2
    local password

    password=$(security find-generic-password -a "$keychain_account" -s "$keychain_password_name" -w 2>/dev/null || true)

    if [ -z "$password" ]; then
        add_password_to_keychain "$keychain_account" "$keychain_password_name"
        password=$(security find-generic-password -a "$keychain_account" -s "$keychain_password_name" -w 2>/dev/null || true)

        if [ -z "$password" ]; then
            echo "Error: Failed to retrieve password for $keychain_password_name from keychain" >&2
            exit 1
        fi
    fi

    echo "$password"
}

add_password_to_keychain() {
    local keychain_account=$1
    local keychain_password_name=$2
    local password

    if ! security find-generic-password -a "$keychain_account" -s "$keychain_password_name" &>/dev/null; then
        read -s -r -p "Enter password for $keychain_password_name: " password
        echo

        if [ -z "$password" ]; then
            echo "Error: No password provided for $keychain_password_name" >&2
            exit 1
        fi

        if ! security add-generic-password -a "$keychain_account" -s "$keychain_password_name" -w "$password"; then
            echo "Error: Failed to add password for $keychain_password_name to keychain" >&2
            exit 1
        fi
    fi
}

AD_PASSWORD="$(get_keychain_password "$AD_ACCOUNT" "$AD_PASSWORD_NAME")"
export AD_PASSWORD

VPN_SHARED_SECRET="$(get_keychain_password "$VPN_SHARED_SECRET_NAME" "VPN:$VPN_SHARED_SECRET_NAME")"
export VPN_SHARED_SECRET
