#!/bin/bash

root_dir="$(pwd)"
test "${1}" && root_dir="${1}"

test -f "${CUSTOM_BIN_DIR}/prettyprint" && source "${CUSTOM_BIN_DIR}/prettyprint"

function pull_branch() {
    test "${2}" || return 1
    if git -C "${2}" checkout "${1}" &> /dev/null; then
        git -C "${2}" pull --quiet --rebase
        [ $? -eq 0 ] && substep_success "Pulled ${1}" || substep_error "Pulling ${1} failed"
        git -C "${2}" checkout --quiet -
    fi
}

info "Checking ${root_dir} for git updates..."
find "${root_dir}" -mindepth 0 -maxdepth 3 -type d -or -type l | while read dir; do
    if [ -d "${dir}/.git" ]; then
        substep_info "Updating ${dir}"
		pull_branch "master" "${dir}"
		pull_branch "2.0.x" "${dir}"
		pull_branch "2.1.x" "${dir}"
		pull_branch "2.2.x" "${dir}"
        branch_name=$(git -C "${dir}" rev-parse --abbrev-ref HEAD)
        if [ "${branch_name}" != "master" ]; then
            git -C "${dir}" pull --quiet --rebase
            [ $? -eq 0 ] && substep_success "Pulled ${branch_name}" || substep_error "Pulling ${branch_name} failed"
        fi
    fi
done
success "Done pulling updates."

