#!/bin/bash

if ! test "${TM_USER}"; then
    echo "TM_USER is not set"
    exit 1
fi

BACKUP_DIR="${WDIR}/private/infrastructure/backup/teslamate"
BACKUP_PATH="${BACKUP_DIR}/$(date +%Y-%m-%dT%H-%M-%S).sql"

kubectl exec -i deployment/teslamate-mazzotta-db-deployment -n teslamate-mazzotta -- /bin/sh -c "pg_dump -U ${TM_USER} -d ${TM_USER}" > "${BACKUP_PATH}"

if [[ $? == 0 ]]; then
    tmbackupverify "${BACKUP_PATH}"
else
    echo "Backup FAILED"
fi

