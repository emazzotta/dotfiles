#!/usr/bin/env python3

import sys
from pathlib import Path
from subprocess import run
from time import time


COMPOSE_FILE = Path.home() / "Projects" / "private" / "opencode" / "docker-compose.yml"


def normalize_file_path(file_path: str) -> str:
    if not file_path.startswith('./') and not file_path.startswith('/'):
        return f"./{file_path}"
    return file_path


def resolve_absolute_path(file_path: str, pwd: Path) -> Path:
    path = Path(file_path)
    if path.is_absolute():
        return path.resolve()
    return (pwd / file_path).resolve()


def validate_file_exists(absolute_path: Path, original_path: str) -> None:
    if not absolute_path.exists():
        print(f"Error: File not found: {original_path}", file=sys.stderr)
        sys.exit(1)


def validate_file_in_pwd(absolute_path: Path, pwd: Path, original_path: str) -> Path:
    try:
        return absolute_path.relative_to(pwd)
    except ValueError:
        print(f"Error: File must be within PWD: {original_path}", file=sys.stderr)
        sys.exit(1)


def build_volume_args_for_pwd(pwd: Path) -> list[str]:
    return ["-v", f"{pwd}:/workspace/code"]


def build_volume_args_for_files(files: list[str], pwd: Path) -> list[str]:
    volume_args: list[str] = []
    for file_path in files:
        normalized_path = normalize_file_path(file_path)
        absolute_path = resolve_absolute_path(normalized_path, pwd)
        validate_file_exists(absolute_path, file_path)
        relative_path = validate_file_in_pwd(absolute_path, pwd, file_path)
        host_path = pwd / relative_path
        volume_args.extend(["-v", f"{host_path}:/workspace/code/{relative_path}"])
    return volume_args


def build_volume_args(files: list[str], pwd: Path) -> list[str]:
    if not files:
        return build_volume_args_for_pwd(pwd)
    return build_volume_args_for_files(files, pwd)


def main() -> None:
    pwd = Path.cwd()
    files: list[str] = []
    resume = False

    args = sys.argv[1:]
    i = 0
    while i < len(args):
        if args[i] in ("-f", "--file"):
            if i + 1 >= len(args):
                print("Error: -f/--file requires a file path", file=sys.stderr)
                sys.exit(1)
            files.append(args[i + 1])
            i += 2
        elif args[i] in ("-r", "--resume"):
            resume = True
            i += 1
        else:
            print(f"Error: Unknown argument: {args[i]}", file=sys.stderr)
            print("Usage: cl [-f FILE]... [-r]", file=sys.stderr)
            sys.exit(1)

    volume_args = build_volume_args(files, pwd)

    claude_args = ["--resume"] if resume else []
    container_name = f"opencode-{int(time())}"

    command = [
        "docker", "compose",
        "-f", str(COMPOSE_FILE),
        "-p", "opencode",
        "run", "--remove-orphans", "--rm",
        "--name", container_name,
        *volume_args,
        "opencode",
        "claude",
        *claude_args,
    ]

    result = run(command)
    sys.exit(result.returncode)


if __name__ == "__main__":
    main()
