#!/usr/bin/env python3

import sys
from pathlib import Path
from subprocess import run
from time import time


COMPOSE_FILE = Path.home() / "Projects" / "private" / "opencode" / "docker-compose.yml"


def main() -> None:
    pwd = Path.cwd()
    files: list[str] = []
    resume = False

    args = sys.argv[1:]
    i = 0
    while i < len(args):
        if args[i] in ("-f", "--file"):
            if i + 1 >= len(args):
                print("Error: -f/--file requires a file path", file=sys.stderr)
                sys.exit(1)
            files.append(args[i + 1])
            i += 2
        elif args[i] in ("-r", "--resume"):
            resume = True
            i += 1
        else:
            print(f"Error: Unknown argument: {args[i]}", file=sys.stderr)
            print("Usage: cl [-f FILE]... [-r]", file=sys.stderr)
            sys.exit(1)

    if not files:
        volume_args = ["-v", f"{pwd}:/workspace/code"]
    else:
        volume_args = []
        for file_path in files:
            absolute_path = (Path(file_path) if Path(file_path).is_absolute() else pwd / file_path).resolve()
            if not absolute_path.exists():
                print(f"Error: File not found: {file_path}", file=sys.stderr)
                sys.exit(1)
            try:
                relative_path = absolute_path.relative_to(pwd)
            except ValueError:
                print(f"Error: File must be within PWD: {file_path}", file=sys.stderr)
                sys.exit(1)
            volume_args.extend(["-v", f"{absolute_path}:/workspace/code/{relative_path}"])

    claude_args = ["--resume"] if resume else []
    container_name = f"opencode-{int(time())}"

    command = [
        "docker", "compose",
        "-f", str(COMPOSE_FILE),
        "-p", "opencode",
        "run", "--remove-orphans", "--rm",
        "--name", container_name,
        *volume_args,
        "opencode",
        "claude",
        *claude_args,
    ]

    result = run(command)
    sys.exit(result.returncode)


if __name__ == "__main__":
    main()
