#!/usr/bin/env python3

import argparse
import glob
import sys
from pathlib import Path
from subprocess import run
from time import time


COMPOSE_FILE = Path.home() / "Projects" / "private" / "opencode" / "docker-compose.yml"


def parse_path(path_str: str) -> Path:
    path = Path(path_str).resolve()
    if not path.exists():
        raise argparse.ArgumentTypeError(f"Path does not exist: {path_str}")
    if not path.is_dir():
        raise argparse.ArgumentTypeError(f"Path is not a directory: {path_str}")
    return path


def validate_file_in_pwd(absolute_path: Path, pwd: Path, original_path: str) -> Path:
    try:
        return absolute_path.relative_to(pwd)
    except ValueError:
        print(f"Error: File must be within PWD: {original_path}", file=sys.stderr)
        sys.exit(1)


def build_volume_args(files: list[str], paths: list[Path], pwd: Path) -> list[str]:
    if not files and not paths:
        return ["-v", f"{pwd}:/workspace/code"]

    volume_args: list[str] = []
    for path in paths:
        volume_args.extend(["-v", f"{path}:/workspace/code/{path.name}"])
    for file_path in files:
        volume_args.extend(resolve_file_volume_args(file_path, pwd))
    return volume_args


def resolve_file_volume_args(file_path: str, pwd: Path) -> list[str]:
    if any(c in file_path for c in ("*", "?", "[")):
        return expand_glob_volume_args(file_path, pwd)
    return single_file_volume_args(file_path, pwd)


def expand_glob_volume_args(pattern: str, pwd: Path) -> list[str]:
    matches = glob.glob(pattern, root_dir=pwd)
    if not matches:
        print(f"Error: No files matched pattern: {pattern}", file=sys.stderr)
        sys.exit(1)
    volume_args: list[str] = []
    for match in matches:
        volume_args.extend(single_file_volume_args(match, pwd))
    return volume_args


def single_file_volume_args(file_path: str, pwd: Path) -> list[str]:
    p = Path(file_path)
    absolute_path = p.resolve() if p.is_absolute() else (pwd / file_path).resolve()
    if not absolute_path.exists():
        print(f"Error: File not found: {file_path}", file=sys.stderr)
        sys.exit(1)
    relative_path = validate_file_in_pwd(absolute_path, pwd, file_path)
    return ["-v", f"{pwd / relative_path}:/workspace/code/{relative_path}"]


def main() -> None:
    pwd = Path.cwd()

    parser = argparse.ArgumentParser(prog="cl", usage="cl [-f FILE]... [-p PATH]... [CLAUDE_ARGS...]")
    parser.add_argument("-f", "--file", dest="files", action="extend", nargs="+", default=[], metavar="FILE")
    parser.add_argument("-p", "--path", dest="paths", action="append", type=parse_path, default=[], metavar="PATH")

    args, claude_args = parser.parse_known_args()

    volume_args = build_volume_args(args.files, args.paths, pwd)
    container_name = f"opencode-{int(time())}"

    command = [
        "docker", "compose",
        "-f", str(COMPOSE_FILE),
        "-p", "opencode",
        "run", "--remove-orphans", "--rm",
        "--name", container_name,
        *volume_args,
        "opencode",
        "claude",
        *claude_args,
    ]

    result = run(command)
    sys.exit(result.returncode)


if __name__ == "__main__":
    main()
