#!/bin/bash

progressbar_length=14
test "${1}" && progressbar_length="${1}"
test "${2}" && mode="${2}"

printer() {
    title="${1}"
    ratio="${2}"
    progressbar="${3}"
    percentage="${4}"
    [[ "${mode}" == "telegram-formatting" ]] && \
        printf "${title} ${ratio}\n%${progressbar_length}s %.2f%%\n" "${progressbar}" "${percentage}" && \
        return
    printf "%-14s %9s [%${progressbar_length}s] %.2f%%\n" "${title}" "${ratio}" "${progressbar}" "${percentage}" 
}

week=$(date +%V | sed 's/^0*//') 
test ${week} -ge 38 && test ${week} -le 51 && semweek="$((${week}-37))" 
test ${week} -ge 8 && test ${week} -le 21 && semweek="$((${week}-7))" 

# Semester week
if test ${semweek}; then
    max=14
    percentage=$(bc <<< "scale=10; 100/${max}*${semweek}")
    progressbar=$(progressbar ${semweek} ${max} ${progressbar_length} "◼" "◻")
    printer "Semesterwoche" "${semweek}/14" "${progressbar}" "${percentage}"
fi

# Year week
max=52
percentage=$(bc <<< "scale=10; 100/${max}*${week}")
progressbar=$(progressbar ${week} ${max} ${progressbar_length} "◼" "◻")
printer "KW" "${week}/52" "${progressbar}" "${percentage}"

count_down() {
    if date -j &> /dev/null; then
        start_date=$(date -jf "%Y-%m-%d %H:%M:%S" "+%s" "${1}")
        end_date=$(date -jf "%Y-%m-%d %H:%M:%S" "+%s" "${2}")
    else
        start_date=$(date -d "${1}" "+%s")
        end_date=$(date -d "${2}" "+%s" )
    fi
    days_total=$(((${end_date}-${start_date})/(3600*24)))
    days_left=$(((${end_date}-$(date "+%s"))/(3600*24)))
    days_done=$((${days_total}-${days_left}))
    progressbar=$(progressbar ${days_done} ${days_total} ${progressbar_length} "◼" "◻")
    percentage=$(bc <<< "scale=10; 100/${days_total}*${days_done}")
    title="${3}"
    ratio="${days_done}/${days_total}"
    days_left_caption="${days_left} Tage übrig"
    [[ "${days_left}" == 1 ]] && days_left_caption="${days_left} Tag übrig"
    [[ "${mode}" == "telegram-formatting" ]] && ratio="${ratio}\n${days_left_caption}"
    [[ "${mode}" == "telegram-formatting" ]] && title="\n${title}"
    maximum=100.0
    [ 1 -eq "$(echo "${percentage} <= ${maximum}" | bc)"  ] && printer "${title}" "${ratio}" "${progressbar}" "${percentage}"
}

count_down "2015-09-21 00:00:00" "2019-07-02 00:00:00" "B.Sc. IT 15t"
count_down "2019-02-11 00:00:00" "2019-06-07 15:30:00" "Bachelorarbeit"
[[ "${mode}" == "telegram-formatting"  ]] && count_down "2016-09-19 00:00:00" "2020-07-10 00:00:00" "B.Sc. IT 16t"

