#!/bin/bash

set -euo pipefail

if [ $# -eq 0 ]; then
    echo "Usage: $(basename "$0") <archive-file>" >&2
    echo "Extracts password-protected archive to \$DESKDIR using \$PASSWORD_ZIPS" >&2
    exit 1
fi

ARCHIVE="$1"

if [ ! -f "$ARCHIVE" ]; then
    echo "Error: Archive not found: $ARCHIVE" >&2
    exit 1
fi

if ! command -v 7z &> /dev/null; then
    echo "Error: 7z command not found. Please install p7zip" >&2
    exit 1
fi

if [ -n "${GLOBAL_ENV_FILE:-}" ] && [ -f "$GLOBAL_ENV_FILE" ]; then
    source "$GLOBAL_ENV_FILE"
fi

if [ -z "${DESKDIR:-}" ]; then
    echo "Error: DESKDIR environment variable not set" >&2
    exit 1
fi

if [ -z "${PASSWORD_ZIPS:-}" ]; then
    echo "Error: PASSWORD_ZIPS environment variable not set" >&2
    exit 1
fi

7z x "$ARCHIVE" -o"$DESKDIR" -p"$PASSWORD_ZIPS"
