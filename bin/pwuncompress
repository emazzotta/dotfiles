#!/bin/bash

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/shelllog.sh"

show_usage() {
    cat << EOF
Usage: $(basename "$0") <archive-file>

Extracts password-protected archive to \$DESKDIR using \$PASSWORD_ZIPS

Environment variables required:
  DESKDIR         - Destination directory for extraction
  PASSWORD_ZIPS   - Password for the archive
  GLOBAL_ENV_FILE - (optional) File to source for environment variables

Examples:
  $(basename "$0") archive.7z
  $(basename "$0") /path/to/archive.7z
EOF
}

if [ $# -eq 0 ]; then
    show_usage
    exit 1
fi

ARCHIVE="$1"

if [ ! -f "$ARCHIVE" ]; then
    error "Archive not found: $ARCHIVE"
    exit 1
fi

if ! command -v 7z &> /dev/null; then
    error "7z command not found. Please install p7zip"
    exit 1
fi

if [ -n "${GLOBAL_ENV_FILE:-}" ] && [ -f "$GLOBAL_ENV_FILE" ]; then
    info "Loading environment from $GLOBAL_ENV_FILE"
    source "$GLOBAL_ENV_FILE"
fi

if [ -z "${DESKDIR:-}" ]; then
    error "DESKDIR environment variable not set"
    exit 1
fi

if [ -z "${PASSWORD_ZIPS:-}" ]; then
    error "PASSWORD_ZIPS environment variable not set"
    exit 1
fi

log "Extracting archive: $ARCHIVE"
log "Destination: $DESKDIR"

if 7z x "$ARCHIVE" -o"$DESKDIR" -p"$PASSWORD_ZIPS"; then
    success "Archive extracted successfully"
else
    error "Extraction failed"
    exit 1
fi
