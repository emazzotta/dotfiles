#!/bin/bash

set -e

KEEPALIVE_MINUTES=30
KEEPALIVE_SECONDS=$((KEEPALIVE_MINUTES * 60))
MIN_REMAINING_SECONDS=600

PID_FILE="/tmp/vmup_fileexplorer.pid"
TIMESTAMP_FILE="/tmp/vmup_timestamp"

should_restart=false

# Check if File Explorer is running (check for WinAppHelper process)
if ! pgrep -f "File Explorer.app" > /dev/null 2>&1; then
    should_restart=true
    echo "üîÑ File Explorer not running"
elif [ -f "$PID_FILE" ] && [ -f "$TIMESTAMP_FILE" ]; then
    OLD_PID=$(cat "$PID_FILE")
    if kill -0 "$OLD_PID" 2>/dev/null; then
        start_time=$(cat "$TIMESTAMP_FILE")
        current_time=$(date +%s)
        elapsed=$((current_time - start_time))
        remaining=$((KEEPALIVE_SECONDS - elapsed))
        remaining_mins=$((remaining / 60))

        if [ $remaining -le $MIN_REMAINING_SECONDS ]; then
            should_restart=true
            echo "üîÑ Less than 10 mins remaining (${remaining_mins} mins)"
        else
            echo "‚úÖ VM already active (${remaining_mins} mins remaining)"
            exit 0
        fi
    else
        should_restart=true
        echo "üîÑ Timer process not running"
    fi
else
    should_restart=true
fi

if [ "$should_restart" = true ]; then
    # Clean up old timer if exists
    if [ -f "$PID_FILE" ]; then
        OLD_PID=$(cat "$PID_FILE")
        kill "$OLD_PID" 2>/dev/null || true
    fi

    FILE_EXPLORER=$(find "$HOME/Applications (Parallels)" -name "File Explorer.app" -type d | head -n 1)
    open "$FILE_EXPLORER"
    echo "‚è≥ Waiting for VM to be ready..."
    sleep 1

    osascript <<EOF 2>/dev/null
tell application "System Events"
    set visible of process "File Explorer" to false
end tell
EOF

    date +%s > "$TIMESTAMP_FILE"
    (sleep $KEEPALIVE_SECONDS && osascript -e 'quit app "File Explorer"' 2>/dev/null && rm -f "$TIMESTAMP_FILE" 2>/dev/null) &
    echo $! > "$PID_FILE"

    echo "‚úÖ VM active (File Explorer hidden, will close in ${KEEPALIVE_MINUTES} mins)"
fi
