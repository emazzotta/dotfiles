#!/bin/bash

set -e

KEEPALIVE_MINUTES=30
KEEPALIVE_SECONDS=$((KEEPALIVE_MINUTES * 60))

PID_FILE="/tmp/vmup_fileexplorer.pid"

if [ -f "$PID_FILE" ]; then
    OLD_PID=$(cat "$PID_FILE")
    if kill -0 "$OLD_PID" 2>/dev/null; then
        kill "$OLD_PID" 2>/dev/null
        echo "üîÑ Reset timer (killed previous wait process)"
    fi
    rm "$PID_FILE"
fi

FILE_EXPLORER=$(find "$HOME/Applications (Parallels)" -name "File Explorer.app" -type d | head -n 1)
open "$FILE_EXPLORER"
echo "‚è≥ Waiting for VM to be ready..."
sleep 1

osascript <<EOF 2>/dev/null
tell application "System Events"
    set visible of process "File Explorer" to false
end tell
EOF

(sleep $KEEPALIVE_SECONDS && osascript -e 'quit app "File Explorer"' 2>/dev/null) &
echo $! > "$PID_FILE"

echo "‚úÖ VM active (File Explorer hidden, will close in ${KEEPALIVE_MINUTES} mins)"
