#!/bin/bash
set -euo pipefail

source leonardo_account

show_usage() {
    echo "Usage: $(basename "$0") [--mount | --unmount | --status]"
    echo ""
    echo "  -m, --mount    Mount the network drive"
    echo "  -u, --unmount  Unmount the network drive"
    echo "  -s, --status   Show whether the network drive is mounted"
}

mount_drive() {
    if mount | grep " on $NETWORK_DRIVE_MOUNT_POINT " > /dev/null; then
        printf "${GREEN}●${RESET} Network drive '$NETWORK_DRIVE_FOLDER' is already mounted\n"
        return
    fi

    if [ ! -d "$NETWORK_DRIVE_MOUNT_POINT" ]; then
        mkdir -p "$NETWORK_DRIVE_MOUNT_POINT"
    fi

    AD_PASSWORD="$AD_PASSWORD" expect -c "
    log_user 0
    spawn mount_smbfs $NETWORK_DRIVE_FULL_URL $NETWORK_DRIVE_MOUNT_POINT
    expect {
        \"Password for $NETWORK_DRIVE_SERVER_IP:\" {
            send \"\$env(AD_PASSWORD)\r\"
            exp_continue
        }
        eof
    }
    "

    if mount | grep " on $NETWORK_DRIVE_MOUNT_POINT " > /dev/null; then
        printf "${GREEN}●${RESET} Network drive '$NETWORK_DRIVE_FOLDER' mounted at $NETWORK_DRIVE_MOUNT_POINT\n"
    else
        printf "${RED}●${RESET} Failed to mount network drive '$NETWORK_DRIVE_FOLDER' at $NETWORK_DRIVE_MOUNT_POINT\n"
    fi
}

status_drive() {
    if mount | grep " on $NETWORK_DRIVE_MOUNT_POINT " > /dev/null; then
        printf "${GREEN}●${RESET} Network drive '$NETWORK_DRIVE_FOLDER' is mounted at $NETWORK_DRIVE_MOUNT_POINT\n"
    else
        printf "${YELLOW}●${RESET} Network drive '$NETWORK_DRIVE_FOLDER' is not mounted\n"
    fi
}

unmount_drive() {
    if ! mount | grep " on $NETWORK_DRIVE_MOUNT_POINT " > /dev/null; then
        return
    fi
    if umount "$NETWORK_DRIVE_MOUNT_POINT" > /dev/null 2>&1; then
        printf "${GREEN}●${RESET} Network drive '$NETWORK_DRIVE_FOLDER' unmounted successfully\n"
    else
        printf "${RED}●${RESET} Failed to unmount network drive '$NETWORK_DRIVE_FOLDER' from $NETWORK_DRIVE_MOUNT_POINT\n"
    fi
}

if [ $# -eq 0 ]; then
    show_usage
    exit 0
fi

case "$1" in
    -m|--mount)   mount_drive ;;
    -u|--unmount) unmount_drive ;;
    -s|--status)  status_drive ;;
    *)
        printf "${RED}●${RESET} Unknown parameter: $1\n" >&2
        show_usage
        exit 1
        ;;
esac
