#!/bin/bash

# Quick install (requires sudo for /usr/local/bin):
# curl -fsSL https://raw.githubusercontent.com/emazzotta/dotfiles/refs/heads/master/bin/leonardo_utils_installer | sudo bash
#
# Install to custom directory:
# curl -fsSL https://raw.githubusercontent.com/emazzotta/dotfiles/refs/heads/master/bin/leonardo_utils_installer | bash -s -- ~/bin
#
# Force override existing scripts:
# curl -fsSL https://raw.githubusercontent.com/emazzotta/dotfiles/refs/heads/master/bin/leonardo_utils_installer | sudo bash -s -- /usr/local/bin --force

set -euo pipefail

readonly BASE_URL="https://raw.githubusercontent.com/emazzotta/dotfiles/refs/heads/master/bin"
readonly SCRIPTS=(
    "leonardo_account"
    "leonardo_start"
    "leonardo_vpn_toggle"
    "leonardo_drive"
)
readonly DEFAULT_INSTALL_DIR="/usr/local/bin"

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
RESET='\033[0m'

INSTALL_DIR=""
FORCE_INSTALL=false

log() {
    echo -e "${GREEN}[$(date +'%H:%M:%S')]${RESET} $*"
}

error() {
    echo -e "${RED}ERROR:${RESET} $*" >&2
}

warn() {
    echo -e "${YELLOW}WARN:${RESET} $*"
}

show_usage() {
    cat << EOF
Usage: $(basename "$0") [OPTIONS] [INSTALL_DIR]

Downloads and installs Leonardo utility scripts from GitHub.

Options:
  -f, --force    Skip confirmation prompt for overriding existing scripts
  -h, --help     Show this help message

Arguments:
  INSTALL_DIR    Directory to install scripts (default: ${DEFAULT_INSTALL_DIR})

Scripts installed:
  - leonardo_account
  - leonardo_start
  - leonardo_vpn_toggle
  - leonardo_drive

Examples:
  $(basename "$0")                    # Install to ${DEFAULT_INSTALL_DIR}
  $(basename "$0") /usr/local/bin     # Install to /usr/local/bin
  $(basename "$0") ~/bin              # Install to ~/bin
  $(basename "$0") --force            # Force override existing scripts
  $(basename "$0") --force ~/bin      # Force install to ~/bin
  $(basename "$0") ~/bin --force      # Same as above
EOF
}

check_dependencies() {
    local missing=()
    for cmd in curl chmod mkdir; do
        command -v "$cmd" &>/dev/null || missing+=("$cmd")
    done

    if [ ${#missing[@]} -gt 0 ]; then
        error "Missing required commands: ${missing[*]}"
        exit 1
    fi
}

validate_install_dir() {
    local install_dir="$1"

    if [ ! -d "$install_dir" ]; then
        log "Creating directory: $install_dir"
        if ! mkdir -p "$install_dir"; then
            error "Failed to create directory: $install_dir"
            exit 1
        fi
    fi

    if [ ! -w "$install_dir" ]; then
        error "No write permission for directory: $install_dir"
        error "Try running with sudo or choose a different directory"
        exit 1
    fi
}

check_path_warning() {
    local install_dir="$1"

    if [[ ":${PATH}:" != *":${install_dir}:"* ]]; then
        warn "Directory not in PATH: $install_dir"
        warn "Add to your shell profile: export PATH=\"\${PATH}:${install_dir}\""
    fi
}

check_existing_scripts() {
    local install_dir="$1"
    local existing_scripts=()
    local response

    for script in "${SCRIPTS[@]}"; do
        if [ -f "${install_dir}/${script}" ]; then
            existing_scripts+=("$script")
        fi
    done

    if [ ${#existing_scripts[@]} -eq 0 ]; then
        return 0
    fi

    warn "Found ${#existing_scripts[@]} existing script(s):"
    for script in "${existing_scripts[@]}"; do
        echo "  - $script"
    done
    echo

    if [ "$FORCE_INSTALL" = true ]; then
        log "Force flag enabled, proceeding with override..."
        return 0
    fi

    if [ -t 0 ] && [ -t 1 ]; then
        printf "Some scripts already exist. Override? [y/N] "
        read -r response || response=""
        response="${response:-}"
        response="${response#"${response%%[![:space:]]*}"}"
        response="${response%"${response##*[![:space:]]}"}"
    else
        response=""
    fi

    case "$response" in
        y|Y|yes|Yes|YES)
            log "Proceeding with override..."
            return 0
            ;;
        *)
            if [ -t 0 ] && [ -t 1 ]; then
                log "Installation cancelled by user"
            else
                log "Installation cancelled (non-interactive mode)"
            fi
            exit 0
            ;;
    esac
}

download_script() {
    local script_name="$1"
    local url="${BASE_URL}/${script_name}"
    local temp_file="$2"

    if ! curl -fsSL "$url" -o "$temp_file"; then
        error "Failed to download: $script_name"
        return 1
    fi

    if [ ! -s "$temp_file" ]; then
        error "Downloaded file is empty: $script_name"
        return 1
    fi

    return 0
}

install_script() {
    local script_name="$1"
    local install_dir="$2"
    local temp_file="${install_dir}/.${script_name}.tmp"

    log "Downloading $script_name..."

    if ! download_script "$script_name" "$temp_file"; then
        [ -f "$temp_file" ] && rm -f "$temp_file"
        return 1
    fi

    log "Installing $script_name to $install_dir..."
    mv "$temp_file" "${install_dir}/${script_name}"
    chmod +x "${install_dir}/${script_name}"

    return 0
}

cleanup_temp_files() {
    if [ -n "${INSTALL_DIR}" ] && [ -d "$INSTALL_DIR" ]; then
        rm -f "$INSTALL_DIR"/.leonardo_*.tmp
    fi
}

main() {
    if [ $# -gt 1 ]; then
        show_usage
        exit 1
    fi

    if [ $# -eq 1 ] && { [ "$1" = "-h" ] || [ "$1" = "--help" ]; }; then
        show_usage
        exit 0
    fi

    INSTALL_DIR="${1:-$DEFAULT_INSTALL_DIR}"
    INSTALL_DIR="${INSTALL_DIR/#\~/$HOME}"

    trap cleanup_temp_files EXIT INT TERM

    log "Leonardo Utils Installer"
    log "========================"

    check_dependencies
    validate_install_dir "$INSTALL_DIR"
    check_existing_scripts "$INSTALL_DIR"

    local failed_scripts=()

    for script in "${SCRIPTS[@]}"; do
        if ! install_script "$script" "$INSTALL_DIR"; then
            failed_scripts+=("$script")
        fi
    done

    echo

    if [ ${#failed_scripts[@]} -gt 0 ]; then
        error "Failed to install ${#failed_scripts[@]} script(s):"
        for script in "${failed_scripts[@]}"; do
            echo "  - $script"
        done
        exit 1
    fi

    log "Successfully installed ${#SCRIPTS[@]} scripts to $INSTALL_DIR"
    check_path_warning "$INSTALL_DIR"

    echo
    log "Installation complete!"
}

main "$@"
