#!/bin/bash

# Quick install (requires sudo for /usr/local/bin):
# curl -fsSL -H "Cache-Control: no-cache, no-store" https://raw.githubusercontent.com/emazzotta/dotfiles/refs/heads/master/bin/leonardo_utils_installer | sudo bash
# or with --force override
# curl -fsSL -H "Cache-Control: no-cache, no-store" https://raw.githubusercontent.com/emazzotta/dotfiles/refs/heads/master/bin/leonardo_utils_installer | sudo bash -s -- /usr/local/bin --force

set -euo pipefail

readonly BASE_URL="https://raw.githubusercontent.com/emazzotta/dotfiles/refs/heads/master/bin"
readonly SCRIPTS=(
    "host-resolver"
    "leonardo_account"
    "leonardo_drive"
    "leonardo_start"
    "leonardo_vpn_toggle"
)
readonly DEFAULT_INSTALL_DIR="/usr/local/bin"

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
RESET='\033[0m'

INSTALL_DIR=""
FORCE_INSTALL=false
UNINSTALL=false

log() {
    echo -e "${GREEN}[$(date +'%H:%M:%S')]${RESET} $*"
}

error() {
    echo -e "${RED}ERROR:${RESET} $*" >&2
}

warn() {
    echo -e "${YELLOW}WARN:${RESET} $*"
}

show_usage() {
    cat << EOF
Usage: $(basename "$0") [OPTIONS] [INSTALL_DIR]

Downloads and installs Leonardo utility scripts from GitHub.

Options:
  -f, --force      Skip confirmation prompt for overriding existing scripts
  -u, --uninstall  Remove installed scripts from INSTALL_DIR
  -h, --help       Show this help message

Arguments:
  INSTALL_DIR    Directory to install/uninstall scripts (default: ${DEFAULT_INSTALL_DIR})

Scripts installed:
  - leonardo_account
  - leonardo_start
  - leonardo_vpn_toggle
  - leonardo_drive

Examples:
  $(basename "$0")                        Install to ${DEFAULT_INSTALL_DIR}
  $(basename "$0") /usr/local/bin         Install to /usr/local/bin
  $(basename "$0") ~/bin                  Install to ~/bin
  $(basename "$0") --force                Force override existing scripts
  $(basename "$0") --force ~/bin          Force install to ~/bin
  $(basename "$0") ~/bin --force          Same as above
  $(basename "$0") --uninstall            Uninstall from ${DEFAULT_INSTALL_DIR}
  $(basename "$0") --uninstall ~/bin      Uninstall from ~/bin
EOF
}

check_dependencies() {
    local missing=()
    for cmd in curl chmod mkdir; do
        command -v "$cmd" &>/dev/null || missing+=("$cmd")
    done

    if [ ${#missing[@]} -gt 0 ]; then
        error "Missing required commands: ${missing[*]}"
        exit 1
    fi
}

validate_install_dir() {
    local install_dir="$1"

    if [ ! -d "$install_dir" ]; then
        log "Creating directory: $install_dir"
        if ! mkdir -p "$install_dir"; then
            error "Failed to create directory: $install_dir"
            exit 1
        fi
    fi

    if [ ! -w "$install_dir" ]; then
        error "No write permission for directory: $install_dir"
        error "Try running with sudo or choose a different directory"
        exit 1
    fi
}

check_path_warning() {
    local install_dir="$1"

    if [[ ":${PATH}:" != *":${install_dir}:"* ]]; then
        warn "Directory not in PATH: $install_dir"
        warn "Add to your shell profile: export PATH=\"\${PATH}:${install_dir}\""
    fi
}

check_existing_scripts() {
    local install_dir="$1"
    local existing_count=0
    local response

    for script in "${SCRIPTS[@]}"; do
        if [ -f "${install_dir}/${script}" ]; then
            existing_count=$((existing_count + 1))
        fi
    done

    if [ "$existing_count" -eq 0 ]; then
        return 0
    fi

    if [ "$existing_count" -lt "${#SCRIPTS[@]}" ]; then
        warn "Some scripts already exist and will be skipped:"
        for script in "${SCRIPTS[@]}"; do
            if [ -f "${install_dir}/${script}" ]; then
                echo "  - $script"
            fi
        done
        echo
        return 0
    fi

    warn "All scripts already exist in $install_dir"
    echo

    if [ "$FORCE_INSTALL" = true ]; then
        log "Force flag enabled, proceeding with override..."
        return 0
    fi

    if [ -t 0 ] && [ -t 1 ]; then
        printf "All scripts already exist. Override? [y/N] "
        read -r response || response=""
        response="${response:-}"
        response="${response#"${response%%[![:space:]]*}"}"
        response="${response%"${response##*[![:space:]]}"}"
    else
        response=""
    fi

    case "$response" in
        y|Y|yes|Yes|YES)
            log "Proceeding with override..."
            return 0
            ;;
        *)
            if [ -t 0 ] && [ -t 1 ]; then
                log "Installation cancelled by user"
            else
                log "Installation cancelled (non-interactive mode)"
            fi
            exit 0
            ;;
    esac
}

download_script() {
    local script_name="$1"
    local url="${BASE_URL}/${script_name}"
    local temp_file="$2"

    if ! curl -fsSL "$url" -o "$temp_file"; then
        error "Failed to download: $script_name"
        return 1
    fi

    if [ ! -s "$temp_file" ]; then
        error "Downloaded file is empty: $script_name"
        return 1
    fi

    return 0
}

install_script() {
    local script_name="$1"
    local install_dir="$2"
    local target="${install_dir}/${script_name}"
    local temp_file="${install_dir}/.${script_name}.tmp"

    if [ -f "$target" ] && [ "$FORCE_INSTALL" = false ]; then
        log "Skipping $script_name (already installed)"
        return 0
    fi

    log "Downloading $script_name..."

    if ! download_script "$script_name" "$temp_file"; then
        [ -f "$temp_file" ] && rm -f "$temp_file"
        return 1
    fi

    log "Installing $script_name to $install_dir..."
    /bin/mv "$temp_file" "$target"
    chmod +x "$target"

    return 0
}

cleanup_temp_files() {
    if [ -n "${INSTALL_DIR}" ] && [ -d "$INSTALL_DIR" ]; then
        rm -f "$INSTALL_DIR"/.*.tmp
    fi
}

uninstall_scripts() {
    local install_dir="$1"

    log "Uninstalling scripts from $install_dir..."

    for script in "${SCRIPTS[@]}"; do
        local target="${install_dir}/${script}"
        if [ -f "$target" ]; then
            log "Removing $script..."
            /bin/rm -f "$target"
        else
            warn "Not found, skipping: $script"
        fi
    done

    log "Uninstall complete."
}

parse_arguments() {
    local args=()

    for arg in "$@"; do
        case "$arg" in
            -h|--help)
                show_usage
                exit 0
                ;;
            -f|--force)
                FORCE_INSTALL=true
                ;;
            -u|--uninstall)
                UNINSTALL=true
                ;;
            -*)
                error "Unknown option: $arg"
                show_usage
                exit 1
                ;;
            *)
                args+=("$arg")
                ;;
        esac
    done

    if [ ${#args[@]} -gt 1 ]; then
        error "Too many arguments"
        show_usage
        exit 1
    fi

    INSTALL_DIR="${args[0]:-$DEFAULT_INSTALL_DIR}"
    INSTALL_DIR="${INSTALL_DIR/#\~/$HOME}"
}

main() {
    parse_arguments "$@"

    trap cleanup_temp_files EXIT INT TERM

    log "Leonardo Utils Installer"
    log "========================"

    if [ "$UNINSTALL" = true ]; then
        uninstall_scripts "$INSTALL_DIR"
        exit 0
    fi

    check_dependencies
    validate_install_dir "$INSTALL_DIR"
    check_existing_scripts "$INSTALL_DIR"

    local failed_scripts=()
    local installed_count=0
    local skipped_count=0

    for script in "${SCRIPTS[@]}"; do
        if [ -f "${INSTALL_DIR}/${script}" ] && [ "$FORCE_INSTALL" = false ]; then
            skipped_count=$((skipped_count + 1))
            install_script "$script" "$INSTALL_DIR"
        elif install_script "$script" "$INSTALL_DIR"; then
            installed_count=$((installed_count + 1))
        else
            failed_scripts+=("$script")
        fi
    done

    echo

    if [ ${#failed_scripts[@]} -gt 0 ]; then
        error "Failed to install ${#failed_scripts[@]} script(s):"
        for script in "${failed_scripts[@]}"; do
            echo "  - $script"
        done
        exit 1
    fi

    if [ "$skipped_count" -gt 0 ] && [ "$installed_count" -gt 0 ]; then
        log "Installed $installed_count script(s), skipped $skipped_count already-existing script(s) in $INSTALL_DIR"
    elif [ "$skipped_count" -gt 0 ]; then
        log "All scripts already installed in $INSTALL_DIR, nothing to do"
    else
        log "Successfully installed $installed_count script(s) to $INSTALL_DIR"
    fi

    check_path_warning "$INSTALL_DIR"

    echo
    log "Installation complete!"
}

main "$@"
