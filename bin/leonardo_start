#!/bin/bash

source leonardo_account

HOST="iserver.leonardo.local"
MAX_TRIES=2

is_host_reachable() {
    if command -v host-resolver > /dev/null 2>&1; then
        local result
        result=$(host-resolver "$HOST" --timeout 500 2>/dev/null)
        [ "$result" != "127.0.0.1" ]
    else
        ping -c 1 "$HOST" > /dev/null 2>&1
    fi
}

if is_host_reachable; then
  leonardo_vpn_toggle --disable
else
  leonardo_vpn_toggle --enable
fi

for (( i=0; i<MAX_TRIES; i++ )); do
    if is_host_reachable; then
        echo "Leonardo network is reachable."
        leonardo_drive
        exit 0
    fi
    sleep 1
done

echo "$HOST is not reachable after $MAX_TRIES attempts."
exit 1
