#!/bin/bash

source leonardo_account

HOST="iserver.leonardo.local"

is_host_reachable() {
    if command -v host-resolver > /dev/null 2>&1; then
        [ "$(host-resolver "$HOST" --timeout "$1" 2>/dev/null)" != "127.0.0.1" ]
    else
        ping -c 1 -W "$1" "$HOST" > /dev/null 2>&1
    fi
}

if is_host_reachable 250; then
    leonardo_vpn_toggle --disable
    exit 0
fi

leonardo_vpn_toggle --enable

echo "Checking if connection is established..."
DEADLINE=$((SECONDS + 15))
while [ $SECONDS -lt $DEADLINE ]; do
    if is_host_reachable 250; then
        echo "Leonardo network is reachable."
        leonardo_drive
        exit 0
    fi
done

echo "$HOST is not reachable."
exit 1
