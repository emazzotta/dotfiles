#!/bin/bash
set -euo pipefail

source leonardo_account

STATUS_HOST="updates.leonardo.local"

is_network_up() {
    [ "$(host-resolver "$STATUS_HOST" --timeout "$1" 2>/dev/null)" != "127.0.0.1" ]
}

mount_k_drive_on_network_up() {
    if is_network_up 250; then
        printf "${GREEN}●${RESET} Leonardo network is reachable.\n"
        leonardo_drive --mount
        if command -v tailscale-toggle-exit-node > /dev/null 2>&1; then
            tailscale-toggle-exit-node
        fi
        exit 0
    fi
}

if is_network_up 250; then
    leonardo_vpn_toggle --disable
    mount_k_drive_on_network_up
    exit 0
fi

leonardo_vpn_toggle --enable

printf "${YELLOW}●${RESET} Checking if connection is established...\n"
DEADLINE=$((SECONDS + 15))
while [ $SECONDS -lt $DEADLINE ]; do
    mount_k_drive_on_network_up
done

printf "${RED}●${RESET} $STATUS_HOST is not reachable.\n"
exit 1
