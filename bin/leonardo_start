#!/bin/bash
set -euo pipefail

source leonardo_account

STATUS_HOST="updates.leonardo.local"
TIMEOUT_IN_MS=350

is_network_up() {
    [ "$(host-resolver "$STATUS_HOST" --timeout "$1" 2>/dev/null)" != "127.0.0.1" ]
}

mount_k_drive_on_network_up() {
    if is_network_up $TIMEOUT_IN_MS; then
        printf "${GREEN}●${RESET} Leonardo network is reachable.\n"
        leonardo_drive --mount
        if command -v tailscale-toggle-exit-node > /dev/null 2>&1; then
            tailscale-toggle-exit-node
        fi
        return 0
    fi
    return 1
}

disconnect() {
    local disconnected=false

    leonardo_drive --unmount

    if command -v tailscale > /dev/null 2>&1; then
        local ts_state
        ts_state=$(tailscale status --json | jq -r '.BackendState')
        if [ "$ts_state" = "Running" ]; then
            tailscale set --exit-node=
            tailscale down
            scutil --nc stop "Tailscale" 2>/dev/null || true
            printf "${RED}●${RESET} Tailscale disconnected\n"
            disconnected=true
        fi
    fi

    if leonardo_vpn_toggle --disable; then
        disconnected=true
    fi

    scutil --nc stop "Tailscale" 2>/dev/null || true

    if [ "$disconnected" = false ]; then
        printf "${YELLOW}●${RESET} Nothing to disconnect\n"
    fi
}

if [ "${1:-}" = "--disconnect" ]; then
    disconnect
    exit 0
fi

if is_network_up $TIMEOUT_IN_MS; then
    leonardo_vpn_toggle || exit 0
    mount_k_drive_on_network_up && exit 0
fi

if ! is_network_up $TIMEOUT_IN_MS; then
    leonardo_vpn_toggle --enable
    printf "${YELLOW}●${RESET} Waiting for connection to be established...\n"
    DEADLINE=$((SECONDS + 15))
    while [ $SECONDS -lt $DEADLINE ]; do
        mount_k_drive_on_network_up && exit 0
    done
fi

leonardo_drive --unmount
printf "${RED}●${RESET} $STATUS_HOST is not reachable.\n"
exit 1
