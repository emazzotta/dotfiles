#!/bin/bash

set -e

output_filename="merged.wav"
output_format="wav"

show_help() {
    echo "Merge multiple audio files into a single audio file and convert it to the specified format."
    echo
    echo "Usage: $(basename $0) [-o <output_filename>] [-f <format>] <audio files...>"
    echo
    echo "Options:"
    echo "  -o, --output FILENAME    Specify the output file name (default is 'merged.wav')."
    echo "  -f, --format FORMAT      Specify the audio format (e.g., mp3, ogg) after merging."
    echo
    echo "<audio files...>    Space-separated list of audio files to merge."
}

while [[ $# -gt 0 ]]; do
    case "$1" in
        -o|--output)
            output_filename="$2"
            shift
            shift
            ;;
        -f|--format)
            output_format="$2"
            shift
            shift
            ;;
        -h|--help)
            show_help
            exit 0
            ;;
        *)
            break
            ;;
    esac
done

if [ $# -eq 0 ]; then
    echo "Error: No audio files specified."
    show_help
    exit 1
fi

if [ -f "$output_filename" ]; then
    echo -n "The file '$output_filename' already exists. Do you want to overwrite it? (y/N): "
    read -r answer
    if ! echo "${answer}" | grep -iq "^y"; then
        echo "Aborting script."
        exit 1
    fi
fi

TEMP_FILE="$(mktemp)"
TEMP_DIR="$(mktemp -d)"

for file in "$@"; do
    if [ ! -f "$file" ]; then
        echo "Error: File '$file' not found."
        rm -f "$TEMP_FILE"
        rm -rf "$TEMP_DIR"
        exit 1
    fi
    standardized_file="${TEMP_DIR}/standardized_$(basename "$file").wav"
    ffmpeg -y -i "$file" -ar 44100 -ac 2 -acodec pcm_s16le "$standardized_file"
    echo "file '$standardized_file'" >> "$TEMP_FILE"
done

ffmpeg -y -f concat -safe 0 -i "$TEMP_FILE" -c copy "$output_filename"
echo "Audio files have been merged into '$output_filename'."

rm -f "$TEMP_FILE"
rm -rf "$TEMP_DIR"

if [ "$output_format" != "wav" ]; then
    converted_filename="${output_filename%.*}.$output_format"
    audiotox -f "$output_format" -i "$output_filename"
    rm "$output_filename"
    echo "Converted to $converted_filename and original file removed."
fi
