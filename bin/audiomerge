#!/bin/bash

set -e

echo "Starting audio merge script..."

show_help() {
    echo "Usage: $(basename $0) <audio files...>"
    echo "Merge multiple audio files into a single WAV file after standardizing their format."
    echo
    echo "<audio files...>    Space-separated list of audio files to merge."
    echo
    echo "Example: $(basename $0) file1.mp3 file2.ogg"
    echo "This merges 'file1.mp3' and 'file2.ogg' into 'merged.wav' after standardizing formats."
}

# Check if at least one audio file is provided
if [ $# -eq 0 ]; then
    echo "Error: No audio files specified."
    show_help
    exit 1
fi

# Create the file list for ffmpeg
TEMP_FILE="$(mktemp)"
TEMP_DIR="$(mktemp -d)"

for file in "$@"; do
    if [ ! -f "$file" ]; then
        echo "Error: File '$file' not found."
        rm -f "$TEMP_FILE"
        rmdir "$TEMP_DIR"
        exit 1
    fi
    standardized_file="${TEMP_DIR}/standardized_$(basename "$file").wav"
    ffmpeg -y -i "$file" -ar 44100 -ac 2 -acodec pcm_s16le "$standardized_file"
    echo "file '$standardized_file'" >> "$TEMP_FILE"
done

# Perform the concatenation
ffmpeg -y -f concat -safe 0 -i "$TEMP_FILE" -c copy merged.wav
echo "Audio files have been merged into 'merged.wav'."

# Clean up the temporary files
rm -f "$TEMP_FILE"
rm -rf "$TEMP_DIR"
