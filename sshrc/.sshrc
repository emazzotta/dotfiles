#!/bin/bash

if command -v tput &> /dev/null; then
    RESET="\[$(tput sgr0)\]"
    GREEN="\[$(tput setaf 10)\]"
    WHITE="\[$(tput setaf 15)\]"
    CYAN="\[$(tput setaf 14)\]"
    YELLOW="\[$(tput setaf 11)\]"
else
    RESET="\[\033[0m\]"
    GREEN="\[\033[38;5;10m\]"
    WHITE="\[\033[38;5;15m\]"
    CYAN="\[\033[38;5;14m\]"
    YELLOW="\[\033[38;5;11m\]"
fi

export EDITOR='vim'
export PS1="${GREEN}\u@\h${WHITE} ${CYAN}\w ${YELLOW}\\$ ${RESET}"

alias .1='cd ..'
alias .2='cd ../..'
alias .3='cd ../../..'
alias .4='cd ../../../..'
alias .5='cd ../../../../..'
alias .d='cd ${HOME}/Desktop'
alias .du='du -hsx * | sort -rn | head -10'
alias .s='cd ${HOME}/.ssh'
alias ce='crontab -e'
alias cer='sudo crontab -e'
alias cl='crontab -l'
alias clr='sudo crontab -l'
alias dps='docker ps'
alias e='exit'
alias eak='$EDITOR ${HOME}/.ssh/authorized_keys'
alias eh='$EDITOR ${HOME}/.bash_history'
alias ekh='$EDITOR ${HOME}/.ssh/known_hosts'
alias ep='$EDITOR ${HOME}/.bashrc;rp'
alias ev='$EDITOR .env'
alias l='clear'
alias ll='ls -lta'
alias mc='m clean'
alias rp='clear;source ${HOME}/.bashrc'
alias sconf='$EDITOR ${HOME}/.ssh/config'
alias vdc='$EDITOR docker-compose.yml'
alias y='yarn'

_ensure_host_resolver() {
  command -v host-resolver &>/dev/null && return
  local dir="${HOME}/.local/bin"
  local bin="${dir}/host-resolver"
  if [ ! -x "$bin" ]; then
    mkdir -p "$dir"
    if command -v curl &>/dev/null; then
      curl -fsSL "https://raw.githubusercontent.com/emazzotta/dotfiles/refs/heads/master/bin/host-resolver" -o "$bin" || return 1
    elif command -v wget &>/dev/null; then
      wget -qO "$bin" "https://raw.githubusercontent.com/emazzotta/dotfiles/refs/heads/master/bin/host-resolver" || return 1
    else
      return 1
    fi
    chmod +x "$bin"
  fi
  export PATH="${dir}:${PATH}"
}

_ensure_host_resolver
CUSTOM_IP=()
for _h in "updates.leonardo.local" "updates.leonardo.ag"; do
  _ip="$(host-resolver "$_h")"
  [ -n "$_ip" ] && [ "$_ip" != "127.0.0.1" ] && CUSTOM_IP+=("$_ip")
done
unset _h _ip

_detect_ip() {
  local ip
  ip="$(hostname -I 2>/dev/null | awk '{print $1}')"
  [ -n "$ip" ] && { echo "$ip"; return; }
  ip="$(ip addr show 2>/dev/null | grep -oE '([0-9]{1,3}\.){3}[0-9]{1,3}' | grep -v '^127\.' | head -n1)"
  [ -n "$ip" ] && { echo "$ip"; return; }
  ipconfig getifaddr en0 2>/dev/null
}
CURRENT_IP="$(_detect_ip)"

_ip_pattern=" ${CURRENT_IP} "
if [[ " ${CUSTOM_IP[*]} " =~ $_ip_pattern ]]; then
  echo ""
  echo "âš¡ï¸ Recognized host: $(whoami)@${CURRENT_IP} â†’ âš™ï¸  custom env loaded"
  echo ""
  export DOCKER_COMPOSE_DIR=/opt/docker-data
  alias .f='cd ${DOCKER_COMPOSE_DIR}'
else
  echo ""
  echo "ðŸŒ Generic host: $(whoami)@${CURRENT_IP} â†’ ðŸ“¦  default config"
  echo ""
fi

m() {
  if [ -f "Makefile" ]; then
    make "$@"
  elif [ -f "pom.xml" ]; then
    mvn "$@"
  else
    echo "Error: No build file found (Makefile or pom.xml)" >&2
    return 1
  fi
}

dc() {
  (cd "${DOCKER_COMPOSE_DIR:-.}" && docker compose "$@")
}
